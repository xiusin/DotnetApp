# æ–‡æœ¬é€‰æ‹© Popover åŠŸèƒ½ä¿®å¤

## é—®é¢˜æè¿°
æ–‡æœ¬é€‰æ‹©åå¼¹å‡ºçš„ Popover åŠŸèƒ½æ— æ³•æ­£å¸¸æ˜¾ç¤ºã€‚

## é—®é¢˜åŸå› 

### 1. åˆå§‹åŒ–é¡ºåºé”™è¯¯ âŒ
åœ¨ `MainWindow.InitializeAdditionalFeatures()` æ–¹æ³•ä¸­ï¼Œç»„ä»¶çš„åˆå§‹åŒ–é¡ºåºæœ‰é—®é¢˜ï¼š

```csharp
// é”™è¯¯çš„é¡ºåº
_textSelectionPopover = new TextSelectionPopover(_debugOverlay); // _debugOverlay æ­¤æ—¶ä¸º null
_edgeSwipeComponent = new SimpleEdgeComponent(_debugOverlay);    // _debugOverlay æ­¤æ—¶ä¸º null
// ...
_debugOverlay = new EnhancedDebugOverlay(); // åœ¨è¿™é‡Œæ‰åˆå§‹åŒ–
```

**é—®é¢˜**: `_debugOverlay` åœ¨å…¶ä»–ç»„ä»¶éœ€è¦å®ƒä¹‹å‰è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œå¯¼è‡´ä¼ å…¥çš„æ˜¯ `null`ã€‚

### 2. Popover æ˜¾ç¤ºé€»è¾‘ä¸å¤Ÿå¥å£®
- æ²¡æœ‰æ£€æŸ¥çª—å£æ˜¯å¦å·²åŠ è½½
- ä½ç½®è®¾ç½®å¯èƒ½ä¸åˆé€‚ï¼ˆPointer æ¨¡å¼ï¼‰
- é”™è¯¯å¤„ç†ä¸å¤Ÿè¯¦ç»†

### 3. æ–‡æœ¬æ£€æµ‹æ¦‚ç‡è¿‡é«˜
- æ¨¡æ‹Ÿæ–‡æœ¬é€‰æ‹©çš„æ¦‚ç‡ä¸º 30%ï¼Œè¿‡äºé¢‘ç¹
- å¯èƒ½å¯¼è‡´è¿‡å¤šçš„æ—¥å¿—è¾“å‡º

## ä¿®å¤æ–¹æ¡ˆ

### 1. è°ƒæ•´åˆå§‹åŒ–é¡ºåº âœ…

```csharp
private void InitializeAdditionalFeatures()
{
    try
    {
        // é¦–å…ˆåˆå§‹åŒ–è°ƒè¯•è¦†ç›–å±‚ï¼ˆå…¶ä»–ç»„ä»¶éœ€è¦å®ƒï¼‰
        _debugOverlay = new EnhancedDebugOverlay();
        _debugOverlay.ShowDebug();
        _debugOverlay?.LogEvent("ğŸ”§ å¼€å§‹åˆå§‹åŒ–é™„åŠ åŠŸèƒ½...");
        
        // ç„¶ååˆå§‹åŒ–å…¶ä»–ç»„ä»¶
        _textSelectionPopover = new TextSelectionPopover(_debugOverlay);
        _debugOverlay?.LogEvent("âœ… æ–‡æœ¬é€‰æ‹©å¼¹å‡ºæ¡†å·²åˆå§‹åŒ–");
        
        _edgeSwipeComponent = new SimpleEdgeComponent(_debugOverlay);
        _debugOverlay?.LogEvent("âœ… è¾¹ç¼˜æ»‘åŠ¨ç»„ä»¶å·²åˆå§‹åŒ–");
        
        // ... å…¶ä»–ç»„ä»¶
    }
}
```

**æ”¹è¿›**:
- âœ… `_debugOverlay` é¦–å…ˆè¢«åˆå§‹åŒ–
- âœ… æ‰€æœ‰ç»„ä»¶éƒ½èƒ½æ­£ç¡®æ¥æ”¶åˆ° `_debugOverlay` å®ä¾‹
- âœ… æ·»åŠ äº†è¯¦ç»†çš„åˆå§‹åŒ–æ—¥å¿—

### 2. ä¼˜åŒ– ShowPopup æ–¹æ³• âœ…

```csharp
private void ShowPopup()
{
    try
    {
        if (_popup == null)
        {
            _debugOverlay?.LogEvent("âŒ Popup å¯¹è±¡ä¸º null");
            return;
        }

        var window = Application.Current?.ApplicationLifetime 
            is IClassicDesktopStyleApplicationLifetime desktop
            ? desktop.MainWindow : null;
        
        if (window == null) 
        {
            _debugOverlay?.LogEvent("âŒ æ— æ³•è·å–ä¸»çª—å£");
            return;
        }
        
        // ç¡®ä¿çª—å£å·²åŠ è½½
        if (!window.IsLoaded)
        {
            _debugOverlay?.LogEvent("âš ï¸ ä¸»çª—å£å°šæœªåŠ è½½");
            return;
        }
        
        // ä½¿ç”¨å±å¹•ä¸­å¿ƒä½ç½®
        _popup.PlacementTarget = window;
        _popup.Placement = PlacementMode.Center;
        _popup.HorizontalOffset = 0;
        _popup.VerticalOffset = -100; // ç¨å¾®å‘ä¸Šåç§»
        
        if (!_popup.IsOpen)
        {
            _popup.IsOpen = true;
            _popupShowCount++;
            
            _debugOverlay?.LogEvent($"ğŸ‰ æ–‡æœ¬é€‰æ‹©å¼¹å‡ºæ¡†å·²æ˜¾ç¤º (ç¬¬{_popupShowCount}æ¬¡)");
            
            // 5ç§’åè‡ªåŠ¨éšè—
            Task.Delay(5000).ContinueWith(_ =>
            {
                Dispatcher.UIThread.Post(HidePopup);
            });
        }
    }
    catch (Exception ex)
    {
        _debugOverlay?.LogEvent($"âŒ å¼¹å‡ºæ¡†æ˜¾ç¤ºé”™è¯¯: {ex.Message}\nå †æ ˆ: {ex.StackTrace}");
    }
}
```

**æ”¹è¿›**:
- âœ… æ·»åŠ äº† Popup å¯¹è±¡çš„ null æ£€æŸ¥
- âœ… æ£€æŸ¥çª—å£æ˜¯å¦å·²åŠ è½½
- âœ… ä½¿ç”¨ Center ä½ç½®æ¨¡å¼ï¼Œæ›´å¯é 
- âœ… æ£€æŸ¥ Popup æ˜¯å¦å·²ç»æ‰“å¼€
- âœ… å¢åŠ äº†è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼ˆåŒ…å«å †æ ˆè·Ÿè¸ªï¼‰
- âœ… å»¶é•¿è‡ªåŠ¨éšè—æ—¶é—´åˆ° 5 ç§’

### 3. é™ä½æ¨¡æ‹Ÿæ–‡æœ¬é€‰æ‹©æ¦‚ç‡ âœ…

```csharp
// ä» 30% é™ä½åˆ° 5%
if (random.Next(100) < 5) // é™ä½åˆ°5%æ¦‚ç‡ï¼Œé¿å…è¿‡äºé¢‘ç¹
{
    var selectedText = TestTexts[random.Next(TestTexts.Length)];
    _debugOverlay?.LogEvent($"ğŸ¯ æ¨¡æ‹Ÿæ–‡æœ¬é€‰æ‹©: {selectedText}");
    return selectedText;
}
```

**æ”¹è¿›**:
- âœ… é™ä½æ¨¡æ‹Ÿæ¦‚ç‡ï¼Œå‡å°‘å¹²æ‰°
- âœ… å‡å°‘æ—¥å¿—è¾“å‡ºé‡

### 4. ä»£ç ä¼˜åŒ– âœ…

#### 4.1 ä½¿ç”¨é™æ€åªè¯»å­—æ®µ
```csharp
private static readonly string[] TestTexts = 
{
    "Hello World! This is a test.",
    "æµ‹è¯•æ–‡æœ¬é€‰æ‹©åŠŸèƒ½",
    // ...
};
```

#### 4.2 ç®€åŒ–å­—ç¬¦ä¸²æˆªå–
```csharp
// ä½¿ç”¨èŒƒå›´è¿ç®—ç¬¦
clipboardText[..Math.Min(clipboardText.Length, 30)]
```

#### 4.3 è®¾ç½®å­—æ®µä¸º readonly
```csharp
private readonly DebugOverlay? _debugOverlay;
```

#### 4.4 æ¸…ç†ä¸éœ€è¦çš„ using
```csharp
// ç§»é™¤
using Avalonia.Input;
using System.Runtime.InteropServices;
```

#### 4.5 æ·»åŠ  GC.SuppressFinalize
```csharp
public void Dispose()
{
    // ...
    GC.SuppressFinalize(this);
}
```

## æµ‹è¯•æ–¹æ³•

### 1. æ‰‹åŠ¨è§¦å‘æµ‹è¯•
åœ¨è°ƒè¯•é¢æ¿ä¸­ç‚¹å‡»"æµ‹è¯•åŠŸèƒ½"æŒ‰é’®ï¼Œä¼šè§¦å‘æ–‡æœ¬é€‰æ‹©æµ‹è¯•ï¼š

```csharp
_textSelectionPopover?.TriggerTest("æ‰‹åŠ¨æµ‹è¯•æ–‡æœ¬");
```

### 2. è§‚å¯Ÿæ—¥å¿—
æŸ¥çœ‹è°ƒè¯•è¦†ç›–å±‚çš„æ—¥å¿—è¾“å‡ºï¼š
- `ğŸ”§ å¼€å§‹åˆå§‹åŒ–é™„åŠ åŠŸèƒ½...`
- `âœ… æ–‡æœ¬é€‰æ‹©å¼¹å‡ºæ¡†å·²åˆå§‹åŒ–`
- `ğŸ“ æ£€æµ‹åˆ°æ–‡æœ¬é€‰æ‹©: ...`
- `ğŸ‰ æ–‡æœ¬é€‰æ‹©å¼¹å‡ºæ¡†å·²æ˜¾ç¤º (ç¬¬Xæ¬¡)`

### 3. å®é™…æ–‡æœ¬é€‰æ‹©
1. åœ¨ä»»ä½•åº”ç”¨ä¸­é€‰æ‹©æ–‡æœ¬
2. å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆCtrl+Cï¼‰
3. ç­‰å¾…æœ€å¤š 1 ç§’
4. Popover åº”è¯¥ä¼šåœ¨å±å¹•ä¸­å¿ƒä¸Šæ–¹æ˜¾ç¤º

## åŠŸèƒ½è¯´æ˜

### Popover å†…å®¹
- **å¤åˆ¶æŒ‰é’®** (ğŸ“‹ å¤åˆ¶): å°†é€‰ä¸­çš„æ–‡æœ¬å¤åˆ¶åˆ°å‰ªè´´æ¿
- **ç¿»è¯‘æŒ‰é’®** (ğŸŒ ç¿»è¯‘): è§¦å‘ç¿»è¯‘åŠŸèƒ½

### è‡ªåŠ¨éšè—
- Popover ä¼šåœ¨ 5 ç§’åè‡ªåŠ¨éšè—
- ç‚¹å‡»å¤–éƒ¨åŒºåŸŸä¹Ÿä¼šéšè—ï¼ˆIsLightDismissEnabled = trueï¼‰

### æ£€æµ‹æœºåˆ¶
- æ¯ 1 ç§’æ£€æŸ¥ä¸€æ¬¡å‰ªè´´æ¿å†…å®¹
- å¦‚æœæ£€æµ‹åˆ°æ–°çš„æ–‡æœ¬ï¼ˆé•¿åº¦ 1-500 å­—ç¬¦ï¼‰ï¼Œæ˜¾ç¤º Popover
- å¦‚æœæ–‡æœ¬è¢«æ¸…é™¤ï¼Œéšè— Popover

## å·²çŸ¥é™åˆ¶

### 1. æ–‡æœ¬æ£€æµ‹æ–¹å¼
å½“å‰ä½¿ç”¨å‰ªè´´æ¿æ£€æµ‹ï¼Œæœ‰ä»¥ä¸‹é™åˆ¶ï¼š
- éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬ï¼ˆCtrl+Cï¼‰
- æ— æ³•æ£€æµ‹çº¯é¼ æ ‡é€‰æ‹©ï¼ˆæœªå¤åˆ¶ï¼‰
- å¯èƒ½ä¸å…¶ä»–å‰ªè´´æ¿æ“ä½œå†²çª

### 2. æ¨¡æ‹Ÿæ¨¡å¼
ä¸ºäº†æ¼”ç¤ºåŠŸèƒ½ï¼Œæ·»åŠ äº† 5% æ¦‚ç‡çš„æ¨¡æ‹Ÿæ–‡æœ¬é€‰æ‹©ï¼š
- ä»…ç”¨äºæµ‹è¯•å’Œæ¼”ç¤º
- å®é™…åº”ç”¨ä¸­åº”è¯¥ç¦ç”¨æˆ–ç§»é™¤

### 3. è·¨åº”ç”¨æ£€æµ‹
- å¯ä»¥æ£€æµ‹ä»»ä½•åº”ç”¨ä¸­å¤åˆ¶çš„æ–‡æœ¬
- ä½†æ— æ³•åŒºåˆ†æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©

## æœªæ¥æ”¹è¿›å»ºè®®

### 1. æ›´å¥½çš„æ–‡æœ¬é€‰æ‹©æ£€æµ‹
- [ ] ä½¿ç”¨ç³»ç»Ÿçº§é’©å­æ£€æµ‹æ–‡æœ¬é€‰æ‹©
- [ ] ç›‘å¬é¼ æ ‡æ‹–æ‹½äº‹ä»¶
- [ ] é›†æˆ Windows Accessibility API

### 2. æ™ºèƒ½ä½ç½®
- [ ] æ ¹æ®é¼ æ ‡ä½ç½®æ˜¾ç¤º Popover
- [ ] é¿å…é®æŒ¡é€‰ä¸­çš„æ–‡æœ¬
- [ ] è‡ªé€‚åº”å±å¹•è¾¹ç¼˜

### 3. æ›´å¤šåŠŸèƒ½
- [ ] æœç´¢é€‰ä¸­çš„æ–‡æœ¬
- [ ] æ·»åŠ åˆ°ç¬”è®°
- [ ] è‡ªå®šä¹‰å¿«æ·æ“ä½œ

### 4. é…ç½®é€‰é¡¹
- [ ] å…è®¸ç”¨æˆ·å¯ç”¨/ç¦ç”¨åŠŸèƒ½
- [ ] è‡ªå®šä¹‰æ£€æµ‹é—´éš”
- [ ] è‡ªå®šä¹‰è‡ªåŠ¨éšè—æ—¶é—´

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ âŒ
- Popover æ— æ³•æ˜¾ç¤º
- æ²¡æœ‰ä»»ä½•æ—¥å¿—è¾“å‡º
- _debugOverlay ä¸º null
- åˆå§‹åŒ–å¤±è´¥

### ä¿®å¤å âœ…
- Popover æ­£å¸¸æ˜¾ç¤º
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- _debugOverlay æ­£ç¡®åˆå§‹åŒ–
- æ‰€æœ‰ç»„ä»¶æ­£å¸¸å·¥ä½œ
- æ›´å¥å£®çš„é”™è¯¯å¤„ç†
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

## æ€»ç»“

é€šè¿‡è°ƒæ•´åˆå§‹åŒ–é¡ºåºå’Œä¼˜åŒ–æ˜¾ç¤ºé€»è¾‘ï¼Œæ–‡æœ¬é€‰æ‹© Popover åŠŸèƒ½ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚ä¸»è¦ä¿®å¤ç‚¹ï¼š

1. âœ… **åˆå§‹åŒ–é¡ºåº**: _debugOverlay é¦–å…ˆåˆå§‹åŒ–
2. âœ… **æ˜¾ç¤ºé€»è¾‘**: æ·»åŠ äº†å®Œæ•´çš„æ£€æŸ¥å’Œé”™è¯¯å¤„ç†
3. âœ… **ä½ç½®è®¾ç½®**: ä½¿ç”¨ Center æ¨¡å¼ï¼Œæ›´å¯é 
4. âœ… **æ—¥å¿—è¾“å‡º**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
5. âœ… **ä»£ç è´¨é‡**: ä¼˜åŒ–å’Œæ¸…ç†ä»£ç 

ç°åœ¨ç”¨æˆ·å¯ä»¥é€šè¿‡å¤åˆ¶æ–‡æœ¬æ¥è§¦å‘ Popoverï¼Œå¹¶ä½¿ç”¨å¤åˆ¶å’Œç¿»è¯‘åŠŸèƒ½ï¼ğŸ‰
