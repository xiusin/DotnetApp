using Avalonia;
using Avalonia.Controls;
using Avalonia.Input;
using Avalonia.Interactivity;
using Avalonia.Layout;
using Avalonia.Media;
using Avalonia.Threading;
using System;
using System.Threading;
using System.Threading.Tasks;

namespace ConfigButtonDisplay;

public class ClearEdgeComponent : IDisposable
{
    private Window? _edgeWindow;
    private Border? _contentBorder;
    private bool _isWindowVisible = false;
    private DebugOverlay? _debugOverlay;
    private const int WINDOW_WIDTH = 300;
    private const int WINDOW_HEIGHT = 600;
    private DateTime _lastShowTime = DateTime.MinValue;
    private const int MIN_INTERVAL = 3000; // ÊúÄÂ∞èÊòæÁ§∫Èó¥Èöî3Áßí
    private Timer? _autoShowTimer;
    private int _showCount = 0;
    
    // ‰∫ã‰ª∂
    public event EventHandler? WindowOpened;
    public event EventHandler? WindowClosed;
    
    public ClearEdgeComponent(DebugOverlay? debugOverlay = null)
    {
        _debugOverlay = debugOverlay;
        InitializeComponent();
        _debugOverlay?.LogEvent("üöÄ Ê∏ÖÊô∞ËæπÁºòÁªÑ‰ª∂Â∑≤ÂàùÂßãÂåñ");
    }
    
    private void InitializeComponent()
    {
        // ÂàõÂª∫ËæπÁºòÁ™óÂè£
        _edgeWindow = new Window
        {
            Title = "ËæπÁºòÂ∑•ÂÖ∑Ê†è",
            Width = WINDOW_WIDTH,
            Height = WINDOW_HEIGHT,
            WindowStartupLocation = WindowStartupLocation.Manual,
            CanResize = false,
            ShowInTaskbar = false,
            Topmost = false,
            SystemDecorations = SystemDecorations.None,
            Background = new SolidColorBrush(Color.Parse("#F8F9FA")),
            IsEnabled = true
        };
        
        // ËÆæÁΩÆÁ™óÂè£‰ΩçÁΩÆÔºàÂ±èÂπïÂè≥‰æßÔºâ
        PositionWindowAtEdge();
        
        // ÂàõÂª∫ÂÜÖÂÆπÂå∫Âüü
        _contentBorder = new Border
        {
            Background = new SolidColorBrush(Colors.White),
            BorderBrush = new SolidColorBrush(Color.Parse("#E9ECEF")),
            BorderThickness = new Thickness(1),
            CornerRadius = new CornerRadius(12, 0, 0, 12),
            Padding = new Thickness(20)
        };
        
        // ÂàõÂª∫ÂÜÖÂÆπÂÆπÂô®
        var contentStack = new StackPanel
        {
            Spacing = 16
        };
        
        // Ê†áÈ¢ò
        var titleText = new TextBlock
        {
            Text = "ËæπÁºòÂ∑•ÂÖ∑Ê†è",
            FontSize = 18,
            FontWeight = FontWeight.Bold,
            Foreground = new SolidColorBrush(Color.Parse("#1C1E21")),
            HorizontalAlignment = HorizontalAlignment.Center,
            Margin = new Thickness(0, 0, 0, 10)
        };
        
        // Áä∂ÊÄÅÊòæÁ§∫
        var statusTitle = new TextBlock
        {
            Text = "üìä ÁªÑ‰ª∂Áä∂ÊÄÅ",
            FontSize = 14,
            FontWeight = FontWeight.SemiBold,
            Foreground = new SolidColorBrush(Color.Parse("#1890FF"))
        };
        
        var statusText = new TextBlock
        {
            Text = "ÁªÑ‰ª∂Â∑≤ÂàùÂßãÂåñÔºåÁ≠âÂæÖËß¶Âèë",
            FontSize = 12,
            Foreground = new SolidColorBrush(Color.Parse("#666666"))
        };
        
        // ÂäüËÉΩÊåâÈíÆ
        var functionPanel = new StackPanel
        {
            Spacing = 8
        };
        
        AddFunctionButton(functionPanel, "üìù Á¨îËÆ∞", "Âø´ÈÄüËÆ∞ÂΩïÊÉ≥Ê≥ï", OnNoteClick);
        AddFunctionButton(functionPanel, "üîç ÊêúÁ¥¢", "ÊêúÁ¥¢ÂÜÖÂÆπ", OnSearchClick);
        AddFunctionButton(functionPanel, "üéµ Èü≥‰πê", "Êí≠ÊîæÈü≥‰πê", OnMusicClick);
        AddFunctionButton(functionPanel, "üìä ÁªüËÆ°", "Êü•ÁúãÁªüËÆ°", OnStatsClick);
        
        // ÊéßÂà∂ÊåâÈíÆ
        var controlPanel = new StackPanel
        {
            Spacing = 8,
            Margin = new Thickness(0, 20, 0, 0)
        };
        
        var autoShowButton = new Button
        {
            Content = "üéØ Ëá™Âä®ÊòæÁ§∫ÊµãËØï",
            Background = new SolidColorBrush(Color.Parse("#1890FF")),
            Foreground = Brushes.White,
            BorderThickness = new Thickness(0),
            CornerRadius = new CornerRadius(6),
            Padding = new Thickness(12, 8),
            Cursor = new Cursor(StandardCursorType.Hand)
        };
        autoShowButton.Click += (s, e) => TriggerAutoShow();
        
        var manualShowButton = new Button
        {
            Content = "üëÜ ÊâãÂä®ÊòæÁ§∫",
            Background = new SolidColorBrush(Color.Parse("#52C41A")),
            Foreground = Brushes.White,
            BorderThickness = new Thickness(0),
            CornerRadius = new CornerRadius(6),
            Padding = new Thickness(12, 8),
            Cursor = new Cursor(StandardCursorType.Hand)
        };
        manualShowButton.Click += (s, e) => ShowEdgeWindow();
        
        var hideButton = new Button
        {
            Content = "‚úï ÈöêËóè",
            Background = new SolidColorBrush(Color.Parse("#FF4D4F")),
            Foreground = Brushes.White,
            BorderThickness = new Thickness(0),
            CornerRadius = new CornerRadius(6),
            Padding = new Thickness(12, 8),
            Cursor = new Cursor(StandardCursorType.Hand)
        };
        hideButton.Click += (s, e) => HideEdgeWindow();
        
        controlPanel.Children.Add(autoShowButton);
        controlPanel.Children.Add(manualShowButton);
        controlPanel.Children.Add(hideButton);
        
        contentStack.Children.Add(titleText);
        contentStack.Children.Add(statusTitle);
        contentStack.Children.Add(statusText);
        contentStack.Children.Add(functionPanel);
        contentStack.Children.Add(controlPanel);
        
        _contentBorder.Child = contentStack;
        _edgeWindow.Content = _contentBorder;
        
        UpdateStatus("ÁªÑ‰ª∂Â∑≤ÂáÜÂ§áÂ∞±Áª™");
    }
    
    private void AddFunctionButton(Panel parent, string text, string description, EventHandler<RoutedEventArgs> clickHandler)
    {
        var button = new Button
        {
            Content = new StackPanel
            {
                Orientation = Orientation.Horizontal,
                Spacing = 8,
                Children =
                {
                    new TextBlock { Text = text.Split(' ')[0], FontSize = 16 },
                    new StackPanel
                    {
                        Orientation = Orientation.Vertical,
                        Spacing = 2,
                        Children =
                        {
                            new TextBlock { Text = text.Split(' ')[1], FontSize = 13, FontWeight = FontWeight.Medium },
                            new TextBlock { Text = description, FontSize = 11, Foreground = new SolidColorBrush(Color.Parse("#666666")) }
                        }
                    }
                }
            },
            HorizontalAlignment = HorizontalAlignment.Stretch,
            HorizontalContentAlignment = HorizontalAlignment.Left,
            Background = new SolidColorBrush(Colors.White),
            BorderBrush = new SolidColorBrush(Color.Parse("#D1D5DB")),
            BorderThickness = new Thickness(1),
            CornerRadius = new CornerRadius(8),
            Padding = new Thickness(12, 8),
            Margin = new Thickness(0, 2, 0, 2),
            Cursor = new Cursor(StandardCursorType.Hand)
        };
        
        button.Click += (s, e) =>
        {
            _debugOverlay?.LogEvent($"ÁÇπÂáª‰∫Ü: {text}");
            clickHandler?.Invoke(s, e);
        };
        
        parent.Children.Add(button);
    }
    
    private void UpdateStatus(string message)
    {
        // ÁÆÄÂåñÁä∂ÊÄÅÊõ¥Êñ∞ÈÄªËæë
        _debugOverlay?.LogEvent($"Áä∂ÊÄÅÊõ¥Êñ∞: {message}");
    }
    
    private void PositionWindowAtEdge()
    {
        if (_edgeWindow != null)
        {
            try
            {
                // Ëé∑ÂèñÂ±èÂπï‰ø°ÊÅØ
                if (Avalonia.Application.Current?.ApplicationLifetime 
                    is Avalonia.Controls.ApplicationLifetimes.IClassicDesktopStyleApplicationLifetime desktop
                    && desktop.MainWindow != null)
                {
                    var screens = desktop.MainWindow.Screens;
                    if (screens != null && screens.All.Count > 0)
                    {
                        var primaryScreen = screens.All[0];
                        var screenBounds = primaryScreen.Bounds;
                        
                        _edgeWindow.Position = new PixelPoint(
                            screenBounds.X + screenBounds.Width - WINDOW_WIDTH,
                            screenBounds.Y + (screenBounds.Height - WINDOW_HEIGHT) / 2
                        );
                        return;
                    }
                }
                
                // ÈªòËÆ§‰ΩçÁΩÆ
                _edgeWindow.Position = new PixelPoint(1620, 200); // 1920-300=1620, Â±Ö‰∏≠
            }
            catch (Exception ex)
            {
                _debugOverlay?.LogEvent($"ÂÆö‰ΩçÁ™óÂè£ÈîôËØØ: {ex.Message}");
                _edgeWindow.Position = new PixelPoint(1620, 200);
            }
        }
    }
    
    public void TriggerAutoShow()
    {
        var now = DateTime.Now;
        var timeSinceLastShow = (now - _lastShowTime).TotalMilliseconds;
        
        if (timeSinceLastShow < MIN_INTERVAL)
        {
            _debugOverlay?.LogEvent($"‚è∞ ËæπÁºòÁªÑ‰ª∂Èó¥Èöî‰∏çË∂≥ÔºåË∑≥ËøáÊòæÁ§∫ (ËøòÈúÄÁ≠âÂæÖ {MIN_INTERVAL - timeSinceLastShow:F0}ms)");
            return;
        }
        
        if (_isWindowVisible)
        {
            _debugOverlay?.LogEvent("üîÑ ËæπÁºòÁªÑ‰ª∂Â∑≤Âú®ÊòæÁ§∫‰∏≠ÔºåÂÖàÈöêËóèÂÜçÊòæÁ§∫");
            HideEdgeWindow();
            
            // Âª∂ËøüÂêéÈáçÊñ∞ÊòæÁ§∫
            Task.Delay(1000).ContinueWith(_ =>
            {
                Dispatcher.UIThread.Post(() => ShowEdgeWindow());
            });
        }
        else
        {
            ShowEdgeWindow();
        }
    }
    
    public void ShowEdgeWindow()
    {
        if (_edgeWindow == null || _isWindowVisible) return;
        
        _isWindowVisible = true;
        WindowOpened?.Invoke(this, EventArgs.Empty);
        _showCount++;
        
        try
        {
            _edgeWindow.Show();
            _lastShowTime = DateTime.Now;
            UpdateStatus($"Á¨¨{_showCount}Ê¨°ÊòæÁ§∫ - {DateTime.Now:HH:mm:ss}");
            _debugOverlay?.LogEvent($"üéâ ËæπÁºòÁ™óÂè£Â∑≤ÊòæÁ§∫ (Á¨¨{_showCount}Ê¨°)");
            
            // 8ÁßíÂêéËá™Âä®ÈöêËóè
            Task.Delay(8000).ContinueWith(_ =>
            {
                Dispatcher.UIThread.Post(() =>
                {
                    if (_isWindowVisible)
                    {
                        HideEdgeWindow();
                    }
                });
            });
        }
        catch (Exception ex)
        {
            _debugOverlay?.LogEvent($"‚ùå ÊòæÁ§∫ËæπÁºòÁ™óÂè£ÈîôËØØ: {ex.Message}");
            _isWindowVisible = false;
        }
    }
    
    public void HideEdgeWindow()
    {
        if (_edgeWindow == null || !_isWindowVisible) return;
        
        _isWindowVisible = false;
        WindowClosed?.Invoke(this, EventArgs.Empty);
        
        try
        {
            _edgeWindow.Hide();
            UpdateStatus("Á™óÂè£Â∑≤ÈöêËóè");
            _debugOverlay?.LogEvent("ËæπÁºòÁ™óÂè£Â∑≤ÈöêËóè");
        }
        catch (Exception ex)
        {
            _debugOverlay?.LogEvent($"‚ùå ÈöêËóèËæπÁºòÁ™óÂè£ÈîôËØØ: {ex.Message}");
        }
    }
    
    private void OnNoteClick(object? sender, RoutedEventArgs e)
    {
        _debugOverlay?.LogEvent("üìù Á¨îËÆ∞ÂäüËÉΩË¢´ÁÇπÂáª");
    }
    
    private void OnSearchClick(object? sender, RoutedEventArgs e)
    {
        _debugOverlay?.LogEvent("üîç ÊêúÁ¥¢ÂäüËÉΩË¢´ÁÇπÂáª");
    }
    
    private void OnMusicClick(object? sender, RoutedEventArgs e)
    {
        _debugOverlay?.LogEvent("üéµ Èü≥‰πêÂäüËÉΩË¢´ÁÇπÂáª");
    }
    
    private void OnStatsClick(object? sender, RoutedEventArgs e)
    {
        _debugOverlay?.LogEvent("üìä ÁªüËÆ°ÂäüËÉΩË¢´ÁÇπÂáª");
    }
    
    public void Dispose()
    {
        _autoShowTimer?.Dispose();
        _autoShowTimer = null;
        
        if (_edgeWindow != null)
        {
            try
            {
                _edgeWindow.Close();
                _edgeWindow = null;
            }
            catch (Exception ex)
            {
                _debugOverlay?.LogEvent($"ÂÖ≥Èó≠ËæπÁºòÁ™óÂè£ÈîôËØØ: {ex.Message}");
            }
        }
        
        _contentBorder = null;
        _debugOverlay?.LogEvent("Ê∏ÖÊô∞ËæπÁºòÁªÑ‰ª∂Â∑≤Ê∏ÖÁêÜ");
    }
}